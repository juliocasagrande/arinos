<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gráficos Temporais</title> <!-- Título inicial da página -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Link para o Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Link para o Font Awesome para adicionar ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Ajustes para a sidebar */
        body {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .sidebar {
            min-width: 200px;
            max-width: 200px;
            background-color: #343a40;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            width: calc(100% - 200px); /* Considera a largura da sidebar */
        }

        /* Contêiner para manter os gráficos dentro da largura da página e com padding */
        #plots-container {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        .plot-container {
            width: 100%;
            margin-bottom: 40px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .sidebar-footer {
            padding: 10px;
            font-size: 0.9em;
            color: #aaa;
            text-align: center;
            border-top: 1px solid #555;
        }

        /* Estilo para rolagem na tabela de dados */
        #data-display {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Mantém o cabeçalho da tabela fixo */
        table thead th {
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 1;
        }

        /* Estilo para o controle de datas, visível apenas na seção de gráficos */
        .date-filter {
            display: none;
            margin-top: 20px;
        }

        .date-filter.active {
            display: block;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar p-3">
    <div>
        <h2>Navegação</h2>
        <h6>SE Solar Arinos ☀</h6>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('plots-section', 'Gráficos Temporais')">
                    <i class="fas fa-chart-line"></i> Gráficos
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('data-section', 'Dados dos Parques Solares')">
                    <i class="fas fa-table"></i> Dados
                </a>
            </li>
        </ul>

        <!-- Controle de seleção de datas para filtrar o período dos gráficos -->
        <div id="date-filter" class="date-filter">
            <h6>Filtrar por Período</h6>
            <label for="start-date">Data Início:</label>
            <input type="date" id="start-date" class="form-control">
            <label for="end-date">Data Fim:</label>
            <input type="date" id="end-date" class="form-control">
            <button onclick="aplicarFiltro()" class="btn btn-primary mt-2">Aplicar Filtro</button>
        </div>
    </div>
    <div class="sidebar-footer">
        Designed by Júlio Casagrande
    </div>
</div>

<!-- Conteúdo Principal -->
<div class="content">
    <h1 id="page-title">Gráficos Temporais</h1> <!-- Título inicial da página -->

    <!-- Seção dos Gráficos -->
    <div id="plots-section" class="section active">
        <div id="plots-container">
            <div id="plots"></div>
        </div>
    </div>

    <!-- Seção dos Dados -->
    <div id="data-section" class="section">
        <h4>Selecione o parque a ser analisado</h4>
        <select id="parque-select" class="form-select" onchange="mostrarDados()">
            <option value="">Selecione um parque</option>
            <option value="ARN08">Parque ARN08</option>
            <option value="ARN09">Parque ARN09</option>
            <option value="ARN10">Parque ARN10</option>
        </select>
        <div id="data-display" class="mt-3"></div>
    </div>
</div>

<script>
    const parques = ["ARN08", "ARN09", "ARN10"];
    let dadosOriginais = {}; // Armazena os dados completos para cada parque

    async function carregarDados(parque) {
        const response = await fetch(`${parque}.json`);
        const data = await response.json();
        dadosOriginais[parque] = data; // Armazena os dados completos para uso futuro
        atualizarGrafico(parque, data);
    }

    function atualizarGrafico(parque, data) {
        const datas = data.map(d => new Date(d.Data));
        const irradiancia = data.map(d => d['P_GHI_1 Value']);
        const angulo = data.map(d => d['_POA_ANG Value']);
        const temperatura = data.map(d => d['_T_INT Value']);

        const traceIrradiancia = {
            x: datas,
            y: irradiancia,
            mode: 'lines',
            name: 'Irradiância',
            line: { color: 'rgba(255, 99, 132, 0.8)' }
        };

        const traceAngulo = {
            x: datas,
            y: angulo,
            mode: 'lines',
            name: 'Ângulo Tracker',
            yaxis: 'y2',
            line: { color: 'rgba(54, 162, 235, 0.8)' }
        };

        const traceTemperatura = {
            x: datas,
            y: temperatura,
            mode: 'lines',
            name: 'Temperatura',
            yaxis: 'y2',
            line: { color: 'rgba(75, 192, 192, 0.8)' }
        };

        const layout = {
            title: `Dados do Parque: ${parque}`,
            xaxis: { title: 'Data' },
            yaxis: { title: 'Irradiância' },
            yaxis2: {
                title: 'Ângulo e Temperatura',
                overlaying: 'y',
                side: 'right'
            },
            legend: { x: 1.05, y: 1 },
            margin: { l: 50, r: 50, t: 50, b: 50 },
            autosize: true,
            height: 400,
            plot_bgcolor: "rgba(0,0,0,0)"
        };

        const plotDiv = document.createElement('div');
        plotDiv.className = 'plot-container';
        document.getElementById('plots').appendChild(plotDiv);

        Plotly.newPlot(plotDiv, [traceIrradiancia, traceAngulo, traceTemperatura], layout);
    }

    // Carrega e exibe gráficos para cada parque
    parques.forEach(parque => carregarDados(parque));

    function showSection(sectionId, pageTitle) {
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        
        document.title = pageTitle;
        document.getElementById("page-title").textContent = pageTitle;

        // Exibe ou oculta o controle de data na sidebar
        const dateFilter = document.getElementById("date-filter");
        if (sectionId === 'plots-section') {
            dateFilter.classList.add("active");
        } else {
            dateFilter.classList.remove("active");
        }
    }

    // Aplica o filtro de data ao gráfico atual
    function aplicarFiltro() {
        const startDate = new Date(document.getElementById("start-date").value);
        const endDate = new Date(document.getElementById("end-date").value);

        if (isNaN(startDate) || isNaN(endDate)) {
            alert("Por favor, selecione ambas as datas de início e fim.");
            return;
        }

        // Filtra e atualiza o gráfico para cada parque
        document.getElementById("plots").innerHTML = ""; // Limpa gráficos antigos
        parques.forEach(parque => {
            const dadosFiltrados = dadosOriginais[parque].filter(d => {
                const data = new Date(d.Data);
                return data >= startDate && data <= endDate;
            });
            atualizarGrafico(parque, dadosFiltrados);
        });
    }
</script>

</body>
</html>
